<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Quarkus Chat!</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly-additions.min.css">

    <style>
        #chat {
            resize: none;
            overflow: hidden;
            min-height: 300px;
            max-height: 300px;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-default navbar-pf" role="navigation">
    <div class="navbar-header">
        <a class="navbar-brand" href="/">
            <p><strong>>> Quarkus Chat!</strong></p>
        </a>
    </div>
</nav>
<div class="container">
    <br/>
    <div class="row">
        <input id="name" class="col-md-6" type="text" placeholder="sender name">
        <button id="goOnline" class="col-md-2 btn btn-primary" type="button">Go Online</button>
        <br/>
        <br/>
    </div>
    <div class="row">
        <select id="receiverName" class="col-md-6">
            <option value="" disabled="disabled" selected="selected">Please select a receiver</option>
        </select>
        <br/>
        <br/>
    </div>
    <div class="row">
          <textarea class="col-md-8" id="chat">
            </textarea>
    </div>
    <div class="row">
        <input class="col-md-6" id="msg" type="text" placeholder="enter your message">
        <button class="col-md-1 btn btn-primary" id="send" type="button" disabled>send</button>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/js/patternfly.min.js"></script>

<script type="text/javascript">
    var connected = false;
    var chatSocket;

    $("#chat").attr("disabled", true);

    $( document ).ready(function() {
        $("#goOnline").click(goOnline);
        $("#send").click(sendMessage);
        $("#receiverName").change(changeChat);
        $("#name").keypress(function(event){
            if(event.keyCode == 13 || event.which == 13) {
                goOnline();
            }
        });
        $("#msg").keypress(function(event) {
            if(event.keyCode == 13 || event.which == 13) {
                sendMessage();
            }
        });
        $("#chat").change(function() {
            scrollToBottom();
        });
        $("#name").focus();
    });


    var goOnline = function(){
        if (! connected) {
            const senderName = $("#name").val();
            console.log("Val: " + senderName);
            chatSocket = new WebSocket("ws://" + location.host + "/chat/" + senderName);
            chatSocket.onopen = function() {
                connected = true;
                console.log("Connected to the web socket");
                $("#goOnline").attr("disabled", true);
                $("#name").attr("disabled", true);
                $("#chat").attr("disabled", false);
                $("#send").attr("disabled", false);
                $("#msg").focus();
                updateReceivers();
            };
            chatSocket.onmessage =function(m) {
                const message = m.data;
                console.log("Got message: " + message);
                if(message == "New User") {
                    updateReceivers();
                } else {
                    const selectReceiver = document.getElementById("receiverName");
                    const receiverName = selectReceiver.options[selectReceiver.selectedIndex].text;
                    const jsonMessage = JSON.parse(message);
                    if(jsonMessage.senderName === receiverName){
                        // TODO delete newLine character and include in message
                        $("#chat").val($("#chat").val() + jsonMessage.content + "\n");
                        scrollToBottom();
                    }
                }
            };
        }
    }

    var changeChat = function(){
        $("#msg").focus();
        $("#msg").val("");
        $("#chat").val("");

        const selectReceiver = document.getElementById("receiverName");
        const receiverName = selectReceiver.options[selectReceiver.selectedIndex].text;
        const senderName = $("#name").val();
        const url='http://' + location.host + '/chatHistory/' + receiverName + '/' + senderName;
        const http = new XMLHttpRequest();
        http.open("GET", url);
        http.send();

        http.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                const jsonChat = JSON.parse(this.responseText);
                var message = "";
                for(var i = 0; i<jsonChat.messages.length; i++){
                    message = message + jsonChat.messages[i].contend + "\n" ;
                }
                $("#chat").val($("#chat").val() + message);
            }
        };
    }

    var sendMessage = function() {
        const selectReceiver = document.getElementById("receiverName");
        const receiverName = selectReceiver.options[selectReceiver.selectedIndex].text;
        const senderName = $("#name").val();
        const message = ">> " + senderName + ": " + $("#msg").val();

        var jsonMessage = {};
        jsonMessage["receiverName"] = receiverName;
        jsonMessage["senderName"] = senderName;
        jsonMessage["content"] = message

        chatSocket.send(JSON.stringify(jsonMessage));
        $("#chat").val($("#chat").val() + message +  "\n");
        scrollToBottom();
        $("#msg").val("");
    };

    var updateReceivers = function() {
        const http = new XMLHttpRequest();
        const url='http://' + location.host + '/users';
        http.open("GET", url);
        http.send();

        var select = document.getElementById("receiverName");
        var length = select.options.length;
        for (i = length-1; i > 0; i--) {
            select.options[i] = null;
        }

        http.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var json = JSON.parse(this.responseText);
                json.forEach(function (item, index) {
                    $("#receiverName").append('<option value=' + index + '>' + item.name + '</option>');
                    console.log(item, index);
                });
            }
        };
    };

    var scrollToBottom = function () {
        $('#chat').scrollTop($('#chat')[0].scrollHeight);
    };

</script>
</body>
</html>